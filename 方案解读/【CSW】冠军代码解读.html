<html>
<head>
  <title>【CSW】冠军代码解读</title>
  <basefont face="微软雅黑 Light" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/605766 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑 Light;
      font-size: 14pt;
    }
  </style>
</head>
<body>
<a name="10631"/>
<h1>【CSW】冠军代码解读</h1>

<div>
<span><div><div><br/></div><div><span style="font-size: 18pt; font-weight: bold;">前言</span></div><div> <span style="font-size: 14pt;">       官方提供的test.csv中涉及到210654个商店商品对，这些商品有些属于同一个商店，也有些隶属于不同的商店。比如商店1售卖商品A、B、C，商店2售卖商品B、C、D，那么（1，A）（1，B）（1，C）（2，B）（2，C）（2，D）这些就是商店和商品所构成的配对（商店商品对）。如果对每个商店的商品进行建模，那么需要构建21万个模型，不太现实。因此作者对这21万个商店商品对统一建模，将所有商店商品对的销量时序数据供给给一个模型学习。</span></div><div><span style="font-size: 14pt;">        同时，官方要求预测未来16天的销量，若只构建一个模型，且如果没有关于未来第i天这样类似的特征，那么未来16天的销量预测值是完全相同的。作者针对未来16天的销量预测任务，每天建一个模型，共计16个模型，效果比16天共用一个模型的效果更好。</span></div><div><font style="font-size: 14pt;"><br/></font></div><div><br/></div><div><br/></div><div><span style="font-size: 18pt; font-weight: bold;">Lgb</span></div><div style="text-align: center;"><a href="【CSW】冠军代码解读_files/top1-lgb-solution.ipynb"><img src="【CSW】冠军代码解读_files/37fdef8d692389bec6bfde706b5317e2.png" alt="top1-lgb-solution.ipynb"></a></div><div style="text-align: center;"><span style="font-size: 12pt;">600+特征</span></div><div><span style="font-size: 14pt;">        作者选取了【2017.1.1~2017.8.15】之间train.csv中</span><span style="font-size: 14pt; color: unset; font-family: unset;">出现过的【商店商品对】来</span><span style="font-size: 14pt;">构建训练集和测试集。</span><span style="font-size: 14pt; color: unset; font-family: unset;">若使用【更早时间~2017.8.15】，将会出现更多的【商店商品对】，但模型得分却会下降。其原因在于，过去几年间，有商店倒闭，也有商店开业，有全新商品的上架，也有商品不再贩卖。因此考虑更多的【商店商品对】会使得数据蕴含更多的噪声，不利于模型的泛化能力。之所以选取</span><span style="font-size: 14pt;">【2017.1.1~2017.8.15】</span><span style="font-size: 14pt; color: unset; font-family: unset;">也是在【想获得尽可能全的商店商品对】和【尽量减少不再贩卖的商店商品对所带来的噪声】之间获得一个平衡。</span></div><div><font style="font-size: 14pt;"><br/></font></div><div><span style="font-size: 14pt;">        其次，时间段在【2017.8.16~2017.8.31】之间test.csv中蕴含了210654对【商店商品对】，要比时间段在【2017.1.1~2017.8.15】之间train.csv所蕴含的167515对【商店商品对】多了4万多对。若使用【2017.8.16~2017.8.31】，将会出现更多的【商店商品对】来构建训练和测试数据，但模型得分却会下降。其原因在于，这部分新增的【商店商品对】因为在过去没有销量数据，所以构建的样本其</span><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 14pt; color: rgb(0, 0, 0); font-family: &quot;微软雅黑 Light&quot;; font-variant-caps: normal; font-variant-ligatures: normal;"> </span><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 14pt; color: rgb(0, 0, 0); font-family: &quot;微软雅黑 Light&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">x</span><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 14pt; color: rgb(0, 0, 0); font-family: &quot;微软雅黑 Light&quot;; font-variant-caps: normal; font-variant-ligatures: normal;"> 的</span><span style="font-size: 14pt;">绝大部分元素为0，但模型大概率不会把这些【商店商品对】样本的销量预测为0，而是一个略大于0的值，这与实际有偏差。实际上这些新增的【商店商品对】其【2017.8.16~2017.8.31】之间的销量大部分为0。</span></div><div><font style="font-size: 14pt;"><br/></font></div><div><span style="font-size: 14pt;">        在生成下述的各个宽表之前，作者先将train.csv和test.csv中的所有销量经过log(1+x)操作。</span></div><div><font style="font-size: 14pt;"><br/></font></div><div><span style="font-size: 14pt;">        作者构建如下宽表：</span></div><ul><ul><li><div><span style="font-size: 14pt;">df2017：【2017.1.1~2017.8.15】每天【各商店各商品】的销量（若缺失则默认</span><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 14pt; color: rgb(0, 0, 0); font-family: &quot;微软雅黑 Light&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">销量</span><span style="font-size: 14pt;">为0；167515行）</span></div></li><li><div><span style="font-size: 14pt;">promo_2017：【2017.1.1~2017.8.31】每天【各商店各商品】的促销与否（若缺失则默认不促销；167515行）</span></div></li><li><div><span style="font-size: 14pt;">df_2017_item：【2017.1.1~2017.8.15】每天【各商品】的全国销量之和（4018行）</span></div></li><li><div><span style="font-size: 14pt;">promo_2017_item：【2017.1.1~2017.8.31】每天【各商品】的全国促销之和（4018行）</span></div></li><li><div><span style="font-size: 14pt;">df_2017_store_class：【2017.1.1~2017.8.15】每天【各商店各class】的全国销量之和（15826行）</span></div></li><li><div><span style="font-size: 14pt;">df_2017_promo_store_class：【2017.1.1~2017.8.31】每天【各商店各class】的全国促销之和（15826行）</span></div></li><li><div><span style="font-size: 14pt;">items：各商品的family、class、perishable信息（被reindex到了167515行，对应df2017中每行商品的信息）</span></div></li><li><div><span style="font-size: 14pt;">stores：各商店的city、state、type、cluster信息（</span><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 14pt; color: rgb(0, 0, 0); font-family: &quot;微软雅黑 Light&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">被reindex到了</span><span style="font-size: 14pt;">167515行，对应df2017中每行商店的信息）</span></div></li></ul></ul><div><font style="font-size: 14pt;"><br/></font></div><div><span style="font-size: 14pt;">        数据集准备：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><font style="font-size: 12pt;"># 假设</font><font style="font-size: 12pt;">我们需要预测8.16号当天销量</font></span></div><div><font style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><font><span style="font-size: 12pt;"># 那我们</span><font style="font-size: 12pt;">可以用8.9号之前的销量数据, 构建一个小的<font>训练集(<b>X=</b></font></font></font><font style="font-size: 12pt;">prepare_dataset(df, promo_df, 8月9日), <b>Y=</b>8月9日当天销量)来训练模型</font></font></div><div><font style="background-color: rgb(255, 250, 165);font-size: 12pt;-evernote-highlight:true;"><font># 模型训练完之后, 我们就可以将X=</font>prepare_dataset(df, promo_df, 8月16日)输入模型来预测8.16号当天的销量</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">def prepare_dataset(df, promo_df, date, is_train=True):</font></div><div><font style="font-size: 12pt;">    X = pd.DataFrame()  # 下文的 X += cur 表示: X = pd.concat([X, cur], axis=1)</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    for i in [14, 60, 140]:</font></div><div><font style="font-size: 12pt;">        X += date前i天的促销总数</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    for i in [3, 7, 14]:</font></div><div><font style="font-size: 12pt;">        X += date后第1至第i天的促销总数</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    for i in [3, 7, 14, 30, 60, 140]:</font></div><div><font style="font-size: 12pt;">        X += date前i天促销商品每天的平均销量</font></div><div><font style="font-size: 12pt;">        X += date前i天促销商品 权重递增销量的总和（权重符合：0.9^(i-1) 0.9^(i-2), ..., 0.9^1, 0.9^0）</font></div><div><font style="font-size: 12pt;">        X += date前i天不促销商品每天的平均销量</font></div><div><font style="font-size: 12pt;">        X += date前i天不促销商品权重递增销量的总和（权重符合：0.9^(i-1) 0.9^(i-2), ..., 0.9^1, 0.9^0）</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    for i in [3, 7, 14, 30, 60, 140]:</font></div><div><font><span style="font-size: 12pt;">        X += date前i天中i-1个相邻两天销量差值的均值 (mean(0-1,</span> <font><span style="font-size: 12pt;">1-2, 2-3, 3-</span><font style="font-size: 12pt;">4, ...))</font></font></font></div><div><font style="font-size: 12pt;">        X += date前i天权重递增销量的总和（权重符合：0.9^(i-1) 0.9^(i-2), ..., 0.9^1, 0.9^0）</font></div><div><font style="font-size: 12pt;">        X += date前i天销量的均值</font></div><div><font style="font-size: 12pt;">        X += date前i天销量的中位数</font></div><div><font style="font-size: 12pt;">        X += date前i天销量的最小值</font></div><div><font style="font-size: 12pt;">        X += date前i天销量的最大值</font></div><div><font><font><font style="font-size: 12pt;"><font><font>        </font></font>X +=<font><font> date<font>前<font><font>i天销量</font>的<font>标准差</font></font></font></font></font></font></font></font></div><div><font><font style="font-size: 12pt;">        </font></font></div><div><font style="font-size: 12pt;">    for i in [3, 7, 14, 30, 60, 140]:</font></div><div><font style="font-size: 12pt;"><font>        </font>X +=<font> date-timedelta(days=7)前i天中i-1个相邻两天销量差值的均值 (mean(0-1, 1-2, 2-3, 3-4, ...))</font></font></div><div><font style="font-size: 12pt;"><font><font>        </font></font>X +=<font><font> date</font>-timedelta(days=7)<font>前i天销量权重递增的总和（权重符合：0.9^(i-1) 0.9^(i-2), ..., 0.9^1, 0.9^0）</font></font></font></div><div><font style="font-size: 12pt;"><font><font>        </font></font>X +=<font><font> date</font>-timedelta(days=7)<font>前i天销量的均值</font></font></font></div><div><font style="font-size: 12pt;"><font><font>        </font></font>X +=<font><font> date</font>-timedelta(days=7)<font>前i天销量的中位数</font></font></font></div><div><font style="font-size: 12pt;"><font><font>        </font></font>X +=<font><font> date</font>-timedelta(days=7)<font>前i天销量的最小值</font></font></font></div><div><font style="font-size: 12pt;"><font><font>        </font></font>X +=<font><font> date</font>-timedelta(days=7)<font>前i天销量的最大值</font></font></font></div><div><font style="font-size: 12pt;"><font><font>        </font></font>X +=<font><font> date</font>-timedelta(days=7)<font>前i天销量的标准差</font></font></font></div><div><font><font style="font-size: 12pt;"><br/></font></font></div><div><font><font style="font-size: 12pt;">    for i in [7, 14, 30, 60, 140]:</font></font></div><div><font style="font-size: 12pt;"><font><font>        </font></font>X +=<font><font> date前i<font>天销量不为0的日期数量</font></font></font></font></div><div><font style="font-size: 12pt;"><font><font>        </font></font>X +=<font><font> date前i天最后一次有销量的日子距今几天</font></font></font></div><div><font style="font-size: 12pt;"><font>        </font>X +=<font> date前i天首次有销量的日子距今几天</font></font></div><div><font style="font-size: 12pt;"><font>        </font>X +=<font> date前i天促销日期的数量</font></font></div><div><font style="font-size: 12pt;"><font>        </font>X +=<font> date前i天最后一次促销距今几天</font></font></div><div><font style="font-size: 12pt;"><font>        </font>X +=<font> date前i天首次促销距今几天</font></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><font>    </font>X +=<font> date后第2-16天促销日期的数量</font></font></div><div><font style="font-size: 12pt;"><font><font>    </font></font>X +=<font><font> date</font>后第2-16天<font>最后一次促销距今几天</font></font></font></div><div><font style="font-size: 12pt;"><font><font>    </font></font>X +=<font><font> date</font>后第2-16天<font>首次促销距今几天</font></font></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    for i in range(1, 16):</font></div><div><font style="font-size: 12pt;"><font>        </font>X +=<font> date前第i天的销量</font></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    for i in range(7):</font></div><div><font style="font-size: 12pt;"><font>        </font>X +=<font> date前4周里每周i的销量平均</font></font></div><div><font style="font-size: 12pt;"><font>        </font>X +=<font> date前20周里每周i的销量平均</font></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    for i in range(-16, 16):</font></div><div><font style="font-size: 12pt;"><font><font>        </font></font>X +=<font><font> date后第i天的促销情况</font></font></font></div><div><font><font style="font-size: 12pt;"><br/></font></font></div><div><font><font><font style="font-size: 12pt;">    if is_train:</font></font></font></div><div><font><font><font style="font-size: 12pt;">        y = df[pd.date_range(date, periods=16)].values</font></font></font></div><div><font><font><font style="font-size: 12pt;">        return X, y</font></font></font></div><div><font><font><font style="font-size: 12pt;">    return X</font></font></font></div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;"><font>def generate_da</font><font>taset(date, isTrain=True):</font></font></div><div><font style="font-size: 12pt;">    i</font><font style="font-size: 12pt;">f isTrain:</font></div><div><font style="font-size: 12pt;">        X, y = prepare_dataset(df2017, promo_2017, date, isTrain)</font></div><div><font style="font-size: 12pt;">    else:</font></div><div><font style="font-size: 12pt;"><font>        </font>X = prepare_dataset(df2017, promo_2017, date, isTrain)</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    X = pd.concat([X, items, stores], axis=1)</font></div><div><font style="font-size: 12pt;">    </font></div><div><font style="font-size: 12pt;">    X2 = prepare_dataset(df_2017_item, promo_2017_item, date, is_train=False)</font></div><div><font style="font-size: 12pt;">    X2.index = df_2017_item.index</font></div><div><font style="font-size: 12pt;">    </font></div><div><font style="font-size: 12pt;">    X3 = prepare_dataset(df_2017_store_class, df_2017_promo_store_class, date, is_train=False)</font></div><div><font style="font-size: 12pt;">    X3.index = df_2017_store_class.index</font></div><div><font style="font-size: 12pt;">    </font></div><div><font style="font-size: 12pt;">    X = X.join(X2, on=&quot;item_nbr&quot;, how=&quot;left&quot;)</font></div><div><font style="font-size: 12pt;">    X = X.join(X3, on=[&quot;store_nbr&quot;, &quot;class&quot;], how=&quot;left&quot;)</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    if isTrain == False:</font></div><div><font style="font-size: 12pt;">        return X</font></div><div><font style="font-size: 12pt;"><font>    return X, y   # X</font>.shape=(167515, num_feats)  <font>y.shape=(167515, 16)</font></font></div></div><div><br/></div><div style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">X_train = pd.DataFrame({})</font></div><div><font style="font-size: 12pt;">y_train = np.empty((0, ))</font></div><div><font style="font-size: 12pt;">for date in [2017.6.14, 2017.6.21, 2017.6.28, 2017.7.5, 2017.7.12, 2017.7.19]:</font></div><div><font style="font-size: 12pt;">    X, y = generate_dataset(date)</font></div><div><font style="font-size: 12pt;">    X_train = X_train.append(X, ignore_index=True)</font></div><div><font style="font-size: 12pt;">    y_train = np.concatenate([y_train, y])</font></div><div><font style="font-size: 12pt;">    </font></div><div><font style="font-size: 12pt;">X_val, y_val = generate_dataset(2017.7.26)</font></div><div><font style="font-size: 12pt;">X_test = generate_dataset(2017.8.16, isTrain=False)</font></div></div></div><div><br/></div><div><span style="font-size: 14pt;">        训练16个模型，分别用于预测未来16天的销量。16个模型共享相同的X，仅是标签y不同。训练时，</span><span style="font-size: 14pt; color: unset; font-family: unset;">对于易变质的样本给予1.25的权重，其余样本给予1的权重。每训练完一个模型，就用该模型预测测试集第n天的销量。</span></div><div><font style="font-size: 14pt;"><br/></font></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt; color: unset; font-family: unset;">        最后，对预测出来的销量数据进行log(1+x)的反变换，对训练集未覆盖到的【商店商品对】销量预测为0，再</span><span style="font-size: 14pt; color: unset; font-family: unset;">对小于0、大于1000的</span><span style="font-size: 14pt; color: unset; font-family: unset;">销量</span><span style="font-size: 14pt; color: unset; font-family: unset;">进行截断。</span></font></div><div><font style="font-size: 14pt;"><br/></font></div><div><font style="font-size: 14pt;"><br/></font></div><div><span style="font-size: unset;"><br/></span></div><div><span style="font-size: 18pt; color: unset; font-family: unset; font-weight: bold;">NN</span></div><div style="text-align: center;"><a href="【CSW】冠军代码解读_files/top1-nn-solution.ipynb"><img src="【CSW】冠军代码解读_files/c4671b51264b88a0440ce5f13ab7abbc.png" alt="top1-nn-solution.ipynb"></a></div><div style="text-align: center;"><span style="font-size: 12pt;">600+特征</span></div><div><span style="font-size: 14pt;">      </span> <span style="font-size: 14pt;"> 神经网络使用的数据</span><span style="font-size: 14pt;">与Lgb</span><span style="font-size: 14pt;">仅有三点不同：</span></div><ul><ul><li><div><span style="font-size: 14pt;">去除了prepare_dataset中如下4组特征</span></div></li></ul></ul><div style="margin-left: 120px;"><span style="font-size: 14pt;">在过去3/7/14/30/60/140天内促销商品每天的平均销量</span></div><div style="margin-left: 120px;"><span style="font-size: 14pt;">在过去3/7/14/30/60/140天内促销商品 权重递增销量的总和</span></div><div style="margin-left: 120px;"><span style="font-size: 14pt;">在过去3/7/14/30/60/140天内不促销商品每天的平均销量</span></div><div style="margin-left: 120px;"><span style="font-size: 14pt;">在过去3/7/14/30/60/140天内不促销商品 权重递增销量的总和</span></div><ul><ul><li><div><span style="font-size: 14pt;">使用的数据是 [2017.5.31, 2017.6.7, 2017.6.14, 2017.6.21, 2017.6.28, 2017.7.5, 2017.7.12, 2017.7.19] 这8个时间点，比Lgb模型多了2017.5.31和2017.6.7这两个时间点</span></div></li><li><div><span style="font-size: 14pt;">把训练、验证、测试数据拼接在一起后做了标准化，并对数据在axis</span><span style="font-size: 14pt;">=1的地方新增了一个维度以输入LSTM</span></div></li></ul></ul><div><font style="font-size: 14pt;"><br/></font></div><div><span style="font-size: 14pt;">        神经网络模型采用LSTM块+6块NN块的设计，模型采用Adam优化，mse损失函数，学习率1e-3，batch size=65536，epochs=2000，也采用了早停和学习率衰减。</span><span style="background-color: rgb(255, 250, 165);font-size: 14pt;-evernote-highlight:true;">值得注意的是，神经网络模型学习的是销量相对y_train销量平均值的偏离</span><span style="font-size: 14pt;">。</span></div><div style="text-align: center;"><img src="【CSW】冠军代码解读_files/Untitled Diagram.png" type="image/png" data-filename="Untitled Diagram.png"/></div><div><br/></div><div><span style="font-size: 14pt;">        同样训练16个模型，分别用于预测未来16天的销量。16个模型共享相同的X，仅是标签y不同。训练时，</span><span style="font-size: 14pt; color: unset; font-family: unset;">对于易变质的样本给予1.25的权重，其余样本给予1的权重。每训练完一个模型，就用该模型预测测试集第n天的销量。</span></div><div><font style="font-size: 14pt;"><br/></font></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt; color: unset; font-family: unset;">        最后，对预测出来的销量数据进行log(1+x)的反变换，对训练集未覆盖到的【商店商品对】销量预测为0，再</span><span style="font-size: 14pt; color: unset; font-family: unset;">对小于0、大于1000的</span><span style="font-size: 14pt; color: unset; font-family: unset;">销量</span><span style="font-size: 14pt; color: unset; font-family: unset;">进行截断。</span></font></div><div><span style="font-size: unset;"><br/></span></div></div><div><br/></div></span>
</div></body></html> 